package Common::Swagger;
our $VERSION = '0.9';

#########################################||#########################################
#                                                                                  #
# Common::Swagger                                                                  #
# Â© Copyright 2011-2014 Scott Offen (http://www.scottoffen.com)                    #
#                                                                                  #
#########################################||#########################################


#----------------------------------------------------------------------------------#
# Pragmas and modules to use                                                       #
#----------------------------------------------------------------------------------#
	use strict;
	use warnings;
	use Common::Config;
	use Common::Logging;
	use Common::Storage qw(GetFileName);
	use Common::Util qw(Declassify);
	use JSON::PP;
	use Data::Dumper;
#----------------------------------------------------------------------------------#


#----------------------------------------------------------------------------------#
# Module Initialization                                                            #
#----------------------------------------------------------------------------------#
BEGIN
{
	#----------------------------------------------------------------------------------#
	# Set default environment variables and untaint them all                           #
	#----------------------------------------------------------------------------------#
	$ENV{REQUEST_METHOD} = 'GET' unless defined $ENV{REQUEST_METHOD};
	$ENV{HTTP_HOST}      = 'localhost' unless defined $ENV{HTTP_HOST};
	$ENV{REQUEST_URI}    = '' unless defined $ENV{REQUEST_URI};
	#----------------------------------------------------------------------------------#
}
#----------------------------------------------------------------------------------#


#----------------------------------------------------------------------------------#
# Global Variables                                                                 #
#----------------------------------------------------------------------------------#
	my  $config    = (exists GetConfig()->{'swagger'}) ? GetConfig()->{'swagger'} : { 'api-version' => '1.0.0', 'swagger-version' => '1.2' };

	our $ENABLED   = 0;
	our $A_VERSION = $config->{'api-version'};
	our $S_VERSION = $config->{'swagger-version'};
	our $RESOURCE  =GetFileName($ENV{REQUEST_URI}) || '';
#----------------------------------------------------------------------------------#


#----------------------------------------------------------------------------------#
# Swagger API                                                                      #
#----------------------------------------------------------------------------------#
our $API =
{
	swaggerVersion => $S_VERSION,
	apiVersion     => $A_VERSION,
	basePath       => "http://$ENV{HTTP_HOST}$ENV{REQUEST_URI}",
	resourcePath   => "/" . $RESOURCE,
	apis           => [],
	models         => {}
};
#----------------------------------------------------------------------------------#


##################################|     new     |###################################
sub new
{
	return bless {}, shift;
}
#########################################||#########################################



#################################|     GetAPI     |#################################
# Public Static                                                                    #
#----------------------------------------------------------------------------------#
sub GetAPI
{
	return $API;
}
#########################################||#########################################



#################################|     Enable     |#################################
# Public Static                                                                    #
#----------------------------------------------------------------------------------#
sub Enable
{
	$ENABLED = 1;
}
#########################################||#########################################



################################|     IsEnabled     |###############################
# Public Static                                                                    #
#----------------------------------------------------------------------------------#
sub IsEnabled
{
	return $ENABLED;
}
#########################################||#########################################



#################################|     Config     |#################################
# Public Static                                                                    #
#----------------------------------------------------------------------------------#
sub Config
{
	my $class  = shift;
	my $params = ((scalar @_ > 0) && (ref $_[0] eq 'HASH')) ? shift : {};

	foreach my $key (keys %$params)
	{
		$API->{$key} = $params->{$key};
	}
}
#########################################||#########################################



#################################|     AddApi     |#################################
# Public Static                                                                    #
#----------------------------------------------------------------------------------#
sub AddApi
{
	my ($api) = Declassify(\@_, __PACKAGE__);
	if (ref $api eq 'HASH')
	{
		push(@{$API->{apis}}, $api);
	}
}
#########################################||#########################################



################################|     AddModel     |################################
# Public Static                                                                    #
# 0 : Object (string, hashref)                                                     #
#----------------------------------------------------------------------------------#
sub AddModel
{
	my ($id, $model) = Declassify(\@_, __PACKAGE__);
	if ((defined $id) && (ref $model eq 'HASH'))
	{
		$API->{models}->{$id} = $model;
	}
}
#########################################||#########################################



################################|     AddModels     |###############################
# Public Static                                                                    #
# 0 : hashref                                                                      #
#----------------------------------------------------------------------------------#
sub AddModels
{
	my ($models) = Declassify(\@_, __PACKAGE__);

	if (ref $models eq 'HASH')
	{
		AddModel($_, $models->{$_}) foreach (keys %$models);
	}
}
#########################################||#########################################



1;